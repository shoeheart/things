moved all codebarn.* domains to aws
moved dns for codebarn.* domains to aws
generated free *.codebarn.* ssl certs
created free tier postgresql 10.4 rds instance
created free tier ec2 ami linux 2 instance
configured billing.codebarn.com s3 bucket for billing, and billing alerts
created rds_ssh.sh to tunnel to private rds via ec2 so can connect pgadmin

brew install awscli
aws configure
(enter access key and secret access key for your IAM user)
aws ecr get-login --no-include-email --region us-east-2
generates big login command like:
docker login -u AWS -p Nms1bTI2WnU1RXVJVms9IiwidmVyc2lvbiI6IjIiLCJ0eXBlIjoiREFUQV9LRVkiLCJleHBpcmF0aW9uIjoxNTMyNzYyNDkzfQ== https://188975917675.dkr.ecr.us-east-2.amazonaws.com

from: https://gorails.com/setup/ubuntu/18.04

sudo apt update
sudo apt upgrade


curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

sudo apt-get update
sudo apt-get install git-core curl zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev software-properties-common libffi-dev nodejs yarn

cd
git clone https://github.com/rbenv/rbenv.git ~/.rbenv
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(rbenv init -)"' >> ~/.bashrc
exec $SHELL

git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
echo 'export PATH="$HOME/.rbenv/plugins/ruby-build/bin:$PATH"' >> ~/.bashrc
exec $SHELL

rbenv install 2.5.1
rbenv global 2.5.1
ruby -v

gem install bundler
rbenv rehash

curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
sudo apt-get install -y nodejs

# add github deploy key:
ssh-keygen -t rsa -b 4095 -C "engineering@codebarn.com"
codebarn_engineering_github
add to github
sudo mkdir /workspace
sudo chown ubuntu /workspace
sudo chgrp ubuntu /workspace
cd /workspace
git clone git@github.com:shoeheart/things.git

# gem install rails -v 5.2.0

sudo sh -c "echo 'deb http://apt.postgresql.org/pub/repos/apt/ bionic-pgdg main' > /etc/apt/sources.list.d/pgdg.list"
wget --quiet -O - http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get install postgresql-common
sudo apt-get install postgresql-10 libpq-dev
sudo systemctl stop postgresql.service
sudo systemctl disable postgresql.service

gem install foreman


# setup foreman as service
cd /workspace/things
mkdir systemd
foreman export systemd systemd -f Procfile.production -a things
sudo su -
cd /lib/systemd/system
cp -r /workspace/things/systemd/* .
systemctl start things.target
systemctl --state=failed

# still had to hand edit a bunch in the end but this got close
foreman export --env .env.production --port 5000 --app things --user ubuntu -f Procfile.production systemd systemd

also had to add this to root/.bashrc since rbenv only installs for
local user "ubuntu" and these are required to run rails executables
in systemd commands:
export RBENV_ROOT=/home/ubuntu/.rbenv
export PATH="/home/ubuntu/.rbenv/bin:$PATH"
eval "$(rbenv init -)"

# deploy
ssh ubuntu@ec2-18-222-124-92.us-east-2.compute.amazonaws.com
sudo systemctl stop things.target
cd /workspace/things
git pull
bundle install
yarn install
NODE_ENV=production bundle exec rails assets:precompile
DISABLE_DATABASE_ENVIRONMENT_CHECK=1 RAILS_ENV=production bundle exec rails db:reset
sudo shutdown -r now


https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-18-04
585  sudo fallocate -l 1G /swapfile
  586  ls -lh /swapfile
  587  sudo chmod 600 /swapfile
  588  ls -lh /swapfile
  589  sudo mkswap /swapfile
  590  sudo swapon --show
  591  free -h
  ubuntu@ip-172-31-23-126:/workspace/things$ cat /etc/fstab
LABEL=cloudimg-rootfs	/	 ext4	defaults,discard	0 0
/swapfile none swap sw 0 0


previous attempt from...ignore this:
from:
https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-16-04

sudo swapon --show
(not output means no swap is set up)
free -h

ubuntu@ip-172-31-23-126:/workspace/things$ free -h
              total        used        free      shared  buff/cache   available
Mem:           983M        398M        194M        764K        391M        419M

ubuntu@ip-172-31-23-126:/workspace/things$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            481M     0  481M   0% /dev
tmpfs            99M  740K   98M   1% /run
/dev/xvda1      7.7G  3.1G  4.7G  40% /
tmpfs           492M     0  492M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           492M     0  492M   0% /sys/fs/cgroup
/dev/loop0       13M   13M     0 100% /snap/amazon-ssm-agent/150
/dev/loop1       87M   87M     0 100% /snap/core/4917
/dev/loop2       87M   87M     0 100% /snap/core/4650
/dev/loop3       13M   13M     0 100% /snap/amazon-ssm-agent/295
tmpfs            99M     0   99M   0% /run/user/1000


sudo fallocate -l 1G /swapfile
ubuntu@ip-172-31-23-126:/workspace/things$ sudo fallocate -l 1G /swapfile
ubuntu@ip-172-31-23-126:/workspace/things$ ls -lh /swapfile
-rw-r--r-- 1 root root 1.0G Jul 30 12:06 /swapfile

ubuntu@ip-172-31-23-126:/workspace/things$ sudo chmod 600 /swapfile
ubuntu@ip-172-31-23-126:/workspace/things$ ls -lh /swapfile
-rw------- 1 root root 1.0G Jul 30 12:06 /swapfile

ubuntu@ip-172-31-23-126:/workspace/things$ sudo mkswap /swapfile
Setting up swapspace version 1, size = 1024 MiB (1073737728 bytes)
no label, UUID=a616e637-dffb-49a0-89f7-21e679eee30d
ubuntu@ip-172-31-23-126:/workspace/things$ sudo swapon --show
ubuntu@ip-172-31-23-126:/workspace/things$
(something wrong here since not showing any swap...will try reboot)

ubuntu@ip-172-31-23-126:/workspace/things$ sudo cp /etc/fstab /etc/fstab.bak
ubuntu@ip-172-31-23-126:/workspace/things$ echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
/swapfile none swap sw 0 0
